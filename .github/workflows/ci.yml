name: run-rz-bindgen
on:
  push:
  workflow_dispatch:
  workflow_call:
    inputs:
      rizin_ref:
        required: false
        type: string
        default: 'dev'

jobs:
  run-bindgen:
    name: Run bindgen
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-2019, macos-latest]

    steps:
    - name: Checkout rz-bindgen
      uses: actions/checkout@v3

    - name: Checkout rizin
      uses: actions/checkout@v3
      with:
        repository: rizinorg/rizin
        path: rizin
        ref: ${{ inputs.rizin_ref }}

    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Create sdist
      run: pip install build && python -m build --sdist

    - name: Run rz-bindgen
      uses: pypa/cibuildwheel@v2.8.0

    - name: Upload sdist
      uses: actions/upload-artifact@v3
      with:
        name: sdist
        path: dist/*.tar.gz

    - name: Upload wheels
      uses: actions/upload-artifact@v3
      with:
        name: wheels
        path: wheelhouse/*.whl
